<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="A long time ago…In a contract, long forgotten at this point, I had to do quite a bit of reverse engineering against a few “hardened“ targets. The targets generally all followed the same types of prote">
<meta property="og:type" content="article">
<meta property="og:title" content="frida-stack, making life a bit nicer while reversing unknown issues">
<meta property="og:url" content="https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/index.html">
<meta property="og:site_name" content="Strazzere">
<meta property="og:description" content="A long time ago…In a contract, long forgotten at this point, I had to do quite a bit of reverse engineering against a few “hardened“ targets. The targets generally all followed the same types of prote">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-06-18T07:00:00.000Z">
<meta property="article:modified_time" content="2024-06-18T22:26:37.104Z">
<meta property="article:author" content="Tim Strazzere">
<meta property="article:tag" content="android">
<meta property="article:tag" content="frida">
<meta property="article:tag" content="reverse-engineering">
<meta property="article:tag" content="typescript">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@timstrazz">
    
    
      
        
          
            <link rel="shortcut icon" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=48">
          
        
      
      
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=192" sizes="192x192">
          
        
      
      
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=180">
          
        
      
    
    <!-- title -->
    <title>frida-stack, making life a bit nicer while reversing unknown issues</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166943540-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-166943540-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Strazzere" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2024/05/generic-functions-for-timing/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&text=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&is_video=false&description=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=frida-stack, making life a bit nicer while reversing unknown issues&body=Check out this article: https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&name=frida-stack, making life a bit nicer while reversing unknown issues&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&t=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#A-long-time-ago%E2%80%A6"><span class="toc-number">1.</span> <span class="toc-text">A long time ago…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#frida-stack"><span class="toc-number">2.</span> <span class="toc-text">frida-stack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Extended-usage"><span class="toc-number">2.1.</span> <span class="toc-text">Extended usage</span></a></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        frida-stack, making life a bit nicer while reversing unknown issues
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Tim Strazzere</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-06-18T07:00:00.000Z" class="dt-published" itemprop="datePublished">2024-06-18</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/typescript/">typescript</a> › <a class="category-link" href="/categories/typescript/frida/">frida</a> › <a class="category-link" href="/categories/typescript/frida/reverse-engineering/">reverse-engineering</a> › <a class="category-link" href="/categories/typescript/frida/reverse-engineering/android/">android</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/android/" rel="tag">android</a>, <a class="p-category" href="/tags/frida/" rel="tag">frida</a>, <a class="p-category" href="/tags/reverse-engineering/" rel="tag">reverse-engineering</a>, <a class="p-category" href="/tags/typescript/" rel="tag">typescript</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="A-long-time-ago…"><a href="#A-long-time-ago…" class="headerlink" title="A long time ago…"></a>A long time ago…</h2><p>In a contract, long forgotten at this point, I had to do quite a bit of reverse engineering against a few “<a target="_blank" rel="noopener" href="https://github.com/strazzere/android-unpacker">hardened</a>“ targets. The targets generally all followed the same types of protection schemes, though they would roll out new versions weekly as well as toggle different anti-debug&#x2F;reverse&#x2F;etc style protections. The client didn’t actually run most of the code, but they wanted a stable environment which could handle bringing up these different targets without needing to worry about what was going on under the hood.</p>
<p>Instead of approaching this as a static project like I normally had done in the past, I began to (at the time) begrudgingly utilize <a target="_blank" rel="noopener" href="https://frida.re/">frida</a>. Like everything in the reverse engineering world, tooling is contentious. Whether you’re asking people if they use <code>IDA</code> (IlFaK WoN’T aCcEpT mY CrEdIt CaRd), <code>ghirda</code> (It’S nOt r2) - mentioning usage of <code>frida</code> will illicit lots of reactions. Over the years, I’ve become a true believer though, once I figured out how to bend the tooling to do exactly what I wanted it too. Enter, hopefully what becomes a bit of a series, some of my tooling from long expired contracts that I’ve found helpful when approaching hardened targets.</p>
<h2 id="frida-stack"><a href="#frida-stack" class="headerlink" title="frida-stack"></a>frida-stack</h2><p>Whenever I approached a hardened target I found myself wanting to just get a lay of the land while I file up the bulk of my tooling. Get <code>IDA</code> to start processing any native code that looks interesting, disassemble everything with <code>baksmali</code> and fire up the application and attach to it with <code>frida</code> for a nice <code>repl</code> session.</p>
<p>Often when something is hardened even slightly, something will get detected as you begin poking around. Just having a <code>repl</code> session open often won’t trigger these types of anti-debug actions, as it only has injected <code>frida</code> into the process space. Sometimes it will occur once you’ve begun hooking functionality.</p>
<p>With this in mind, I tend to just inject and hook my generic anti* utilities into the process. These often rely on hooking <code>libc</code> functionality at a low level, just to see when things get entered&#x2F;exited, etc. One such example function I’ve found useful is to hook <code>_exit</code> from <code>libc</code> (often alongside with <code>abort</code>, <code>exit</code>, <code>kill</code>)</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">hook_exit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> _exitPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;_exit&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_exitPtr) &#123;</span><br><span class="line">    <span class="keyword">const</span> _exit = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(_exitPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(</span><br><span class="line">      _exitPtr,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">status</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] _exit : <span class="subst">$&#123;status&#125;</span> from <span class="subst">$&#123;<span class="variable language_">this</span>.context.pc)&#125;</span>`</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">_exit</span>(status);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">        [<span class="string">&#x27;int&#x27;</span>],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This can be thrown into a <code>repl</code> or script to inject pretty easily. Sometimes just injecting something like this will trigger different packers&#x2F;protections to freak out. Granted, if they detect the injection, and they are <em>not</em> utilizing <code>_exit</code> we won’t see much other than the process die, which is why it can be sometimes nice to just hook a large variety of things wholesale and store those scripts for repeated usage. Though if they <em>do</em> utilize <code>_exit</code> we would get some output like;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Pixel 4::com.example.package ]-&gt; [+] _exit : 0 from 0x7713d25000</span><br></pre></td></tr></table></figure>

<p>Awesome! This is fun and useful because we now know where the <code>_exit</code> function was called from. Obviously, due to our code before, the process still was allowed to exit, which means we can’t skim the <code>/proc/$&#123;pid&#125;/maps</code> to see what that memory specifically was allocated too.</p>
<p>Normally in <code>frida</code> the usage pattern is to do something like the following to that address;</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> f = <span class="title class_">Module</span>.<span class="title function_">getExportByName</span>(<span class="string">&#x27;libcommonCrypto.dylib&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CCCryptorCreate&#x27;</span>);</span><br><span class="line"><span class="title class_">Interceptor</span>.<span class="title function_">attach</span>(f, &#123;</span><br><span class="line">  <span class="title function_">onEnter</span>(<span class="params">args</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;CCCryptorCreate called from:\n&#x27;</span> +</span><br><span class="line">        <span class="title class_">Thread</span>.<span class="title function_">backtrace</span>(<span class="variable language_">this</span>.<span class="property">context</span>, <span class="title class_">Backtracer</span>.<span class="property">ACCURATE</span>)</span><br><span class="line">        .<span class="title function_">map</span>(<span class="title class_">DebugSymbol</span>.<span class="property">fromAddress</span>).<span class="title function_">join</span>(<span class="string">&#x27;\n&#x27;</span>) + <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>(From the <code>Thread.backtrace</code> example on <a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">frida.re&#x2F;docs&#x2F;javascript-api</a>)</p>
<p>This can work well, and when it does we can get a nice layout of which module the context came from. Though I’ve found, especially when digging into dynamically allocated code, this tends to fail. This brings me to the bulk of my code snippet;</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return a decorated string, similar to DebugSymbol.fromAddress</span></span><br><span class="line"><span class="comment"> * and Process.getModuleFromAddress, however if those fail we</span></span><br><span class="line"><span class="comment"> * will forcefully look up the address association via the mappings.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * For some reason, DebugSymbol.fromAddress doesn&#x27;t always work,</span></span><br><span class="line"><span class="comment"> * nor does Process.getModuleFromAddress, so utilize enumerating the</span></span><br><span class="line"><span class="comment"> * addresses manually to figure out what the module is and the local</span></span><br><span class="line"><span class="comment"> * offset inside it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> address Address to look up details for.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> string of relevant data `0x7713d25000 libsharedlib.so:0x1aae8`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getModuleInfo</span>(<span class="params">address: NativePointer</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> debugSymbol = <span class="title class_">DebugSymbol</span>.<span class="title function_">fromAddress</span>(address);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (debugSymbol.<span class="property">moduleName</span>) &#123;</span><br><span class="line">    <span class="comment">// Add local offset?</span></span><br><span class="line">    <span class="keyword">return</span> debugSymbol.<span class="title function_">toString</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// When hooking we might get something interesting like the following;</span></span><br><span class="line">  <span class="comment">//  [</span></span><br><span class="line">  <span class="comment">//    &#123;</span></span><br><span class="line">  <span class="comment">//      &quot;base&quot;: &quot;0x76fa7000&quot;,    &lt;==== [anon:dalvik-free list large object space]</span></span><br><span class="line">  <span class="comment">//      &quot;protection&quot;: &quot;rw-&quot;,           we don&#x27;t actually care about this</span></span><br><span class="line">  <span class="comment">//      &quot;size&quot;: 536870912</span></span><br><span class="line">  <span class="comment">//    &#125;,</span></span><br><span class="line">  <span class="comment">//    &#123;</span></span><br><span class="line">  <span class="comment">//      &quot;base&quot;: &quot;0x771e939000&quot;, &lt;==== this isn&#x27;t the actual base, we need to refind that</span></span><br><span class="line">  <span class="comment">//      &quot;file&quot;: &#123;</span></span><br><span class="line">  <span class="comment">//        &quot;offset&quot;: 663552,</span></span><br><span class="line">  <span class="comment">//         &quot;path&quot;: &quot;/apex/com.android.runtime/lib64/bionic/libc.so&quot;,</span></span><br><span class="line">  <span class="comment">//         &quot;size&quot;: 0</span></span><br><span class="line">  <span class="comment">//      &#125;,</span></span><br><span class="line">  <span class="comment">//     &quot;protection&quot;: &quot;rwx&quot;,</span></span><br><span class="line">  <span class="comment">//     &quot;size&quot;: 4096</span></span><br><span class="line">  <span class="comment">//   &#125;</span></span><br><span class="line">  <span class="comment">// ]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> builtSymbol = &#123;</span><br><span class="line">    <span class="attr">base</span>: <span class="title function_">ptr</span>(<span class="number">0x0</span>),</span><br><span class="line">    <span class="attr">moduleName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">size</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> ranges = <span class="title class_">Process</span>.<span class="title function_">enumerateRanges</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">filter</span>(</span><br><span class="line">    <span class="function">(<span class="params">range</span>) =&gt;</span> range.<span class="property">base</span> &lt;= address &amp;&amp; range.<span class="property">base</span>.<span class="title function_">add</span>(range.<span class="property">size</span>) &gt;= address,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  ranges.<span class="title function_">forEach</span>(<span class="function">(<span class="params">range</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (range.<span class="property">file</span>) &#123;</span><br><span class="line">      builtSymbol.<span class="property">path</span> = range.<span class="property">file</span>.<span class="property">path</span>;</span><br><span class="line">      <span class="keyword">const</span> moduleNameChunks = range.<span class="property">file</span>.<span class="property">path</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">      builtSymbol.<span class="property">moduleName</span> = moduleNameChunks[moduleNameChunks.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      builtSymbol.<span class="property">base</span> = range.<span class="property">base</span>.<span class="title function_">sub</span>(range.<span class="property">file</span>.<span class="property">offset</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  ranges = <span class="title class_">Process</span>.<span class="title function_">enumerateRanges</span>(<span class="string">&#x27;&#x27;</span>).<span class="title function_">filter</span>(</span><br><span class="line">    <span class="function">(<span class="params">range</span>) =&gt;</span> range.<span class="property">base</span> &lt;= builtSymbol.<span class="property">base</span> &amp;&amp; range.<span class="property">base</span>.<span class="title function_">add</span>(range.<span class="property">size</span>) &gt;= builtSymbol.<span class="property">base</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  ranges.<span class="title function_">forEach</span>(<span class="function">(<span class="params">range</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (builtSymbol.<span class="property">base</span> === <span class="title function_">ptr</span>(<span class="number">0x0</span>) || builtSymbol.<span class="property">base</span> &lt; range.<span class="property">base</span>) &#123;</span><br><span class="line">      builtSymbol.<span class="property">base</span> = range.<span class="property">base</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    builtSymbol.<span class="property">size</span> += range.<span class="property">size</span>;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;builtSymbol.base&#125;</span> <span class="subst">$&#123;builtSymbol.moduleName&#125;</span>:<span class="subst">$&#123;address.sub(builtSymbol.base)&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(Source <a target="_blank" rel="noopener" href="https://github.com/rednaga/frida-stack/blob/main/lib/index.ts#L68-L128">https://github.com/rednaga/frida-stack/blob/main/lib/index.ts#L68-L128</a>)</p>
<p>If the <code>DebugSymbol.fromAddress</code> works, awesome, let’s use it. Otherwise, let’s seek the <code>Process</code> ranges and look for what is <em>currently</em> sitting there and decorate a string with exactly that.</p>
<p>Utilizing the above code we can now transform the original example into something like this;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Pixel 4::com.example.package ]-&gt; [+] _exit : 0 from 0x7713d25000 libexamplesharedlib.so:0x1aae8</span><br></pre></td></tr></table></figure>

<p>This means we can see the original address, which often is pretty useless, but more importantly any process&#x2F;modules names as well as the offset from the base. This ends up being much more functional than just the random address in a now dead process - and is something actionable we can toss into our disassembler of choice and begin to start recursing backwards to find who else may call these functions.</p>
<h3 id="Extended-usage"><a href="#Extended-usage" class="headerlink" title="Extended usage"></a>Extended usage</h3><p>Obviously it’s fair game to just take the snippet above, however you can also install this snippet as a module for usage within your own scripts.</p>
<p>Simply install it by utilizing npm;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># npm install frida-stack</span></span><br></pre></td></tr></table></figure>

<p>Then import it and you will get the function statically accessible, or you can utilize the two helper functions to generate stacks whenever you’d like. One is a method of just getting your place&#x2F;stack inside the <code>Java</code> context via <code>Stack.java()</code>. The other you will need to pass a <code>NativePointer</code> to <code>Stack.native(this.context.pc)</code>.</p>
<p>So to tune the script above we used as an example;</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Stack</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;frida-stack&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hook_exit</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> _exitPtr = <span class="title class_">Module</span>.<span class="title function_">findExportByName</span>(<span class="string">&#x27;libc.so&#x27;</span>, <span class="string">&#x27;_exit&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_exitPtr) &#123;</span><br><span class="line">    <span class="keyword">const</span> _exit = <span class="keyword">new</span> <span class="title class_">NativeFunction</span>(_exitPtr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Interceptor</span>.<span class="title function_">replace</span>(</span><br><span class="line">      _exitPtr,</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">NativeCallback</span>(</span><br><span class="line">        <span class="keyword">function</span> (<span class="params">status</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`[+] _exit : <span class="subst">$&#123;status&#125;</span> from <span class="subst">$&#123;Stack.getModuleInfo(<span class="variable language_">this</span>.context.pc)&#125;</span>`</span>);</span><br><span class="line">	        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Stack</span>.<span class="title function_">native</span>(<span class="variable language_">this</span>.<span class="property">context</span>)</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">_exit</span>(status);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&#x27;int&#x27;</span>,</span><br><span class="line">        [<span class="string">&#x27;int&#x27;</span>],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Hopefully this saves others some time while reversing things.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#A-long-time-ago%E2%80%A6"><span class="toc-number">1.</span> <span class="toc-text">A long time ago…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#frida-stack"><span class="toc-number">2.</span> <span class="toc-text">frida-stack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Extended-usage"><span class="toc-number">2.1.</span> <span class="toc-text">Extended usage</span></a></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&text=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&is_video=false&description=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=frida-stack, making life a bit nicer while reversing unknown issues&body=Check out this article: https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&title=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&name=frida-stack, making life a bit nicer while reversing unknown issues&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://strazzere.com/2024/06/frida-stack-making-life-a-bit-nicer/&t=frida-stack, making life a bit nicer while reversing unknown issues"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2008-2024
    Tim Strazzere
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
