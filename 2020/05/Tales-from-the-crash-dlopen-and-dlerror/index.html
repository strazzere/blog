<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="The setupRecently, while attacking a unspecified application, I had the need to do something I consider pretty normal. Hook dlopen() and dlsym() and inject some results for instrumenting what the appl">
<meta property="og:type" content="article">
<meta property="og:title" content="Tales from the crash; dlopen() and dlerror() patterns">
<meta property="og:url" content="https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/index.html">
<meta property="og:site_name" content="Strazzere">
<meta property="og:description" content="The setupRecently, while attacking a unspecified application, I had the need to do something I consider pretty normal. Hook dlopen() and dlsym() and inject some results for instrumenting what the appl">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-05-17T07:00:00.000Z">
<meta property="article:modified_time" content="2024-06-18T21:20:59.085Z">
<meta property="article:author" content="Tim Strazzere">
<meta property="article:tag" content="android">
<meta property="article:tag" content="frida">
<meta property="article:tag" content="reverse-engineering">
<meta name="twitter:card" content="summary">
<meta name="twitter:creator" content="@timstrazz">
    
    
      
        
          
            <link rel="shortcut icon" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=48">
          
        
      
      
        
          
            <link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=192" sizes="192x192">
          
        
      
      
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/6a4b43066d19111e850cb14b45eacf93?s=180">
          
        
      
    
    <!-- title -->
    <title>Tales from the crash; dlopen() and dlerror() patterns</title>
    <!-- async scripts -->
    <!-- Google Analytics -->

  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-166943540-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-166943540-1');
  </script>


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
      <link rel="alternate" href="/true" title="Strazzere" type="application/atom+xml" />
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2020/06/Uncertified-Devices-and-Bad-Advice/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2020/05/quick-n-dirty-check-for-android-binaries/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&text=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&is_video=false&description=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Tales from the crash; dlopen() and dlerror() patterns&body=Check out this article: https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&name=Tales from the crash; dlopen() and dlerror() patterns&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&t=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-setup"><span class="toc-number">1.</span> <span class="toc-text">The setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#There-was-an-attempt%E2%80%A6"><span class="toc-number">2.</span> <span class="toc-text">There was an attempt…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-bad-pattern"><span class="toc-number">3.</span> <span class="toc-text">The bad pattern</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fixing-the-issue"><span class="toc-number">4.</span> <span class="toc-text">Fixing the issue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">5.</span> <span class="toc-text">TLDR</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        Tales from the crash; dlopen() and dlerror() patterns
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Tim Strazzere</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-05-17T07:00:00.000Z" class="dt-published" itemprop="datePublished">2020-05-17</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/android/">android</a> › <a class="category-link" href="/categories/android/reverse-engineering/">reverse engineering</a> › <a class="category-link" href="/categories/android/reverse-engineering/coding/">coding</a>
    </div>


      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/android/" rel="tag">android</a>, <a class="p-category" href="/tags/frida/" rel="tag">frida</a>, <a class="p-category" href="/tags/reverse-engineering/" rel="tag">reverse-engineering</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h2 id="The-setup"><a href="#The-setup" class="headerlink" title="The setup"></a>The setup</h2><p>Recently, while attacking a unspecified application, I had the need to do something I consider pretty normal. Hook <code>dlopen()</code> and <code>dlsym()</code> and inject some results for instrumenting what the application believes should be going on. Annoyingly, the way the application worked was to load an annoying amount of shared libraries. The majority of these libraries had been protected with some unknown obfuscators and a packer – so replicating the environment in isolation would be very tedious. My normal pattern in a simplistic case would be just to use the <a target="_blank" rel="noopener" href="https://github.com/rednaga/native-shim">native-shim</a> – it’s easy, works and gives you a clean “JVM” to work with. Though due to all the re-injections and checks inside protected binaries, the JVM would need to be prepopulated with too much dalvik non-sense. So the obvious solution? Use <a href="frida.re">Frida</a> (or some other generic hooking framework I guess?)!</p>
<p>Very simplistically, I needed to hook <code>dlopen()</code> to watch for a specific shared library, which after some static analysis, appeared to only introduce anti-debugging tricks. After the <code>dlopen()</code> is called, the main loader would then <code>dlsym()</code> some functions and check to see if they exist, call then and check the return values. So basically, the underlying deobfuscated code likely looked like this;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">bool beingDebuged() &#123;</span><br><span class="line">    void *handle;</span><br><span class="line">    bool (* antiFunction1)(void);</span><br><span class="line">    bool (* antiFunction2)(void);</span><br><span class="line">    bool (* antiFunction3)(void);</span><br><span class="line">    bool (* antiFunction4)(void);</span><br><span class="line"></span><br><span class="line">    handle = dlopen (&quot;libantidebugstuff.so&quot;, RTLD_LAZY);</span><br><span class="line">    if (!handle) &#123;</span><br><span class="line">        fputs (&quot;Error initializing antidebug!&quot;, stderr);</span><br><span class="line"></span><br><span class="line">        // library seemed to assume if antidebugging fails to load,</span><br><span class="line">        // that it&#x27;s probably being debugged</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    antiFunction1 = dlsym(handle, &quot;antiFunction1&quot;);</span><br><span class="line">    if (antiFunction1 == NULL)  &#123;</span><br><span class="line">        fputs(&quot;Error getting antiFunction1!&quot;, stderr);</span><br><span class="line"></span><br><span class="line">        // Same as above</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // .. get other functions, etc</span><br><span class="line"></span><br><span class="line">    return ((*antiFunction1)() &amp;&amp; </span><br><span class="line">        (*antiFunction2)() &amp;&amp; </span><br><span class="line">        (*antiFunction3)() &amp;&amp; </span><br><span class="line">        (*antiFunction4)())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above is not the actual code – it was more complex and interweaved throughout the application making it a bit more annoying to solve holistically. If it where the above code, we could just replace the whole bit with a simple NOP function or something. We also had a secondary goal of figuring out where&#x2F;when&#x2F;why these calls had been getting triggered.</p>
<p>In the simplified above example though, can you see what might go wrong with this code? There is an edge case here which is sort of an odd one, that I can only really imagine happening when reverse engineering. Though, dependant on how this code interacts, could potentially reproduce if this code essential for the application to run and fails silently.</p>
<h2 id="There-was-an-attempt…"><a href="#There-was-an-attempt…" class="headerlink" title="There was an attempt…"></a>There was an attempt…</h2><p>So without much thought I simply just sketched out some a simplistic frida function hook per usual and injected it. A gadget was injected into the APK and a handful of files had been stripped out, different ABIs and the antidebug library since we didn’t want it mucking around with any of the memory. If they wanted to open the targeted antidebug library, we would just return a fake handle so it won’t error out, then catch that fake handle and return my <a href="https://strazzere.com/2020/05/making-up-frida-functions/">fake functions</a> for the application to call. That could let us trap the functions or get stacktraces to see where&#x2F;when it was being utilized;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">var cookie = 0xd1ffd1ff;</span><br><span class="line"></span><br><span class="line">Interceptor.attach(Module.findExportByName(null, &#x27;dlopen&#x27;), &#123;</span><br><span class="line">    onEnter: function(args) &#123;</span><br><span class="line">        this.path = Memory.readUtf8String(args[0]);</span><br><span class="line">        this.mode = args[1]);</span><br><span class="line">     &#125;,</span><br><span class="line">    onLeave: function(retval) &#123;</span><br><span class="line">        console.log(&quot;dlopen(&quot; + &quot;path=\&quot;&quot; + Memory.readUtf8String(path) + &quot;\&quot;&quot; + &quot;, mode=&quot; + mode + &quot;)&quot;);</span><br><span class="line">        if (name !== null &amp;&amp; name.endsWith(&#x27;libantidebugstuff.so&#x27;)) &#123;</span><br><span class="line">            retval.replace(cookie)</span><br><span class="line">        &#125;</span><br><span class="line">        return retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(Module.findExportByName(null, &#x27;dlsym&#x27;), &#123;</span><br><span class="line">    onEnter: function(args) &#123;</span><br><span class="line">        this.handle = args[0];</span><br><span class="line">        this.name = Memory.readUtf8String(args[1]);</span><br><span class="line">     &#125;,</span><br><span class="line">    onLeave: function(retval) &#123;</span><br><span class="line">        if(this.handle == cookie) &#123;</span><br><span class="line">            console.log(&quot;dlsym(&quot; + &quot;handle=\&quot;&quot; + this.handle + &quot;\&quot;&quot; + &quot;, name=&quot; + this.name + &quot;) ret : &quot;, retval);</span><br><span class="line">            switch(this.name) &#123;</span><br><span class="line">                case &#x27;antiFunction1&#x27;:</span><br><span class="line">                    retval.replace(antiFunction1);</span><br><span class="line">                    break;</span><br><span class="line">                case &#x27;antiFunction2&#x27;:</span><br><span class="line">                    retval.replace(antiFunction2);</span><br><span class="line">                    break;</span><br><span class="line">                case &#x27;antiFunction3&#x27;:</span><br><span class="line">                    retval.replace(antiFunction3);</span><br><span class="line">                    break;</span><br><span class="line">                case &#x27;antiFunction4&#x27;:</span><br><span class="line">                    retval.replace(antiFunction4);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    console.log(&quot;Don&#x27;t know how to handle requested function : &quot;, this.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Fire it up - worked fine. Tweaked a few things, it crashes. Wait, what? NPE in some unrelated library for the system? This didn’t make sense. Fire it up again with changes removed, breaks again. Except the NPE is somewhere else. What. The. Crap.</p>
<p>Figured it out yet? It took me a while to understand two things. The original code I was injecting against has a bad a pattern in it (which seems surprisingly common?) and I also chose a poor way to interact with this function.</p>
<h2 id="The-bad-pattern"><a href="#The-bad-pattern" class="headerlink" title="The bad pattern"></a>The bad pattern</h2><p>So, per <code>dlopens())</code>, the return value will be <code>NULL</code> if it fails;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">On  success,  dlopen() and dlmopen() return a non-NULL handle for the loaded library.  On error (file could not be found, was not readable,</span><br><span class="line">had the wrong format, or caused errors during loading), these functions return NULL.</span><br><span class="line"></span><br><span class="line">On success, dlclose() returns 0; on error, it returns a nonzero value.</span><br><span class="line"></span><br><span class="line">Errors from these functions can be diagnosed using dlerror(3).</span><br></pre></td></tr></table></figure>

<p>This makes sense, and it looks like both the original author and I are covering for this case.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">handle = dlopen (&quot;libantidebugstuff.so&quot;, RTLD_LAZY);</span><br><span class="line">if (!handle) &#123;</span><br></pre></td></tr></table></figure>

<p>The above code will error if <code>NULL</code>, perfect.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(Module.findExportByName(null, &#x27;dlopen&#x27;), &#123;</span><br><span class="line">    onEnter: function(args) &#123;</span><br><span class="line">        this.path = Memory.readUtf8String(args[0]);</span><br><span class="line">        this.mode = args[1]);</span><br><span class="line">     &#125;,</span><br><span class="line">    onLeave: function(retval) &#123;</span><br><span class="line">        console.log(&quot;dlopen(&quot; + &quot;path=\&quot;&quot; + Memory.readUtf8String(path) + &quot;\&quot;&quot; + &quot;, mode=&quot; + mode + &quot;)&quot;);</span><br><span class="line">        if (name !== null &amp;&amp; name.endsWith(&#x27;libantidebugstuff.so&#x27;)) &#123;</span><br><span class="line">            retval.replace(cookie)</span><br><span class="line">        &#125;</span><br><span class="line">        return retval;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>In the interceptor code, we will catch the <code>retval</code>, which will be <code>NULL</code> as we’ve removed the file and it won’t be found. We then change the <code>retval</code> to not be <code>NULL</code> and the program will be happen and continue it’s execution. Everyone is great, right? Nope, we made a decently sized mistake in some assuming here…</p>
<p>It would appear, that we spaced out about <code>dlerror()</code>, as did the original author (maybe?). The man page of <code>dlopen</code> even told us about it above;</p>
<p><code>Errors from these functions can be diagnosed using dlerror(3).</code></p>
<p>Oh yea, if we let the <code>dlopen</code> function actually get called, a <code>dlerror()</code> will be set, and remain until someone asks for it. This didn’t cross my mind originally as the original author wasn’t using it, so big deal, right? Sadly, no - this was the whole source of the error. By utilizing <code>Interceptor.attach()</code> we’re merely hooking <em>before</em> and <em>after</em> the function call. As <code>libantidebugstuff.so</code> no longer exists, this means the <code>dlerror()</code> call will return a file not found error. Since there was no gating used done by the original author or us based on a <code>dlerror()</code> this will just persist until someone asks for it, wrongly consuming this error as their own. Thus downstream issues which libraries never expected.</p>
<h2 id="Fixing-the-issue"><a href="#Fixing-the-issue" class="headerlink" title="Fixing the issue"></a>Fixing the issue</h2><p>So for our intercepting of the functions to be fixed, we need to replace our <code>attach()</code> call with a <code>replace()</code> call, then we can choose if we want to call the true underlying function. Alternatively you could consume the <code>dlerror()</code> instead, but this feels “wrong” to me.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">var cookie = 0xd1ffd1ff;</span><br><span class="line">var dlopen = new NativeFunction(Module.findExportByName(null, &#x27;dlopen&#x27;), &#x27;pointer&#x27;, [&#x27;pointer&#x27;, &#x27;int&#x27;]);</span><br><span class="line">Interceptor.replace(dlopen, new NativeCallback(function(path, mode) &#123;</span><br><span class="line">    console.log(&quot;dlopen(&quot; + &quot;path=\&quot;&quot; + Memory.readUtf8String(path) + &quot;\&quot;&quot; + &quot;, mode=&quot; + mode + &quot;)&quot;);</span><br><span class="line">    var name = Memory.readUtf8String(path);</span><br><span class="line">    if (name !== null &amp;&amp; name.endsWith(&#x27;libantidebugstuff.so&#x27;)) &#123;</span><br><span class="line">        console.log(&quot;[*] Found the call to libantidebugstuff, replacing with our cookie and not calling dlopen&quot;);</span><br><span class="line">        return new NativePointer(cookie);</span><br><span class="line">    &#125;</span><br><span class="line">    return dlopen(path, mode);</span><br><span class="line">&#125;, &#x27;pointer&#x27;, [&#x27;pointer&#x27;, &#x27;int&#x27;]));</span><br></pre></td></tr></table></figure>

<p>After replacing the original <code>dlopen()</code> hook with the above code, it all worked fine and the random NPEs which had been racing each other, all disappeared.</p>
<p>This sort of had me thinking about <code>dlerror()</code> though and the “proper usage” of it. Generally speaking, I guess most usecases would be sort of fine to ignore this function and just rely on the <code>NULL</code> being returned. Though this seems like it could cause poor results in a complex binary <em>especially if</em> a failed <code>dlopen()</code> in your application is considered not fatal. For this targeting application, it just considered any type of failure to be that the application is being debugged. However, this wouldn’t cause the application to exit by design, though it would crash as other parts of the system pick up the <code>dlerror()</code>. So in this case, maybe no one would care?</p>
<p>Regardless, it would seem the “safest” form of usage for a <code>dlopen()</code> or <code>dlsym()</code> call that is allowed to fail would be something like;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">char *error;</span><br><span class="line"></span><br><span class="line">handle = dlopen (&quot;libantidebugstuff.so&quot;, RTLD_LAZY);</span><br><span class="line">if ((error = dlerror()) != NULL) &#123;</span><br><span class="line">    fputs (error, stderr);</span><br><span class="line"></span><br><span class="line">    // library seemed to assume if antidebugging fails to load,</span><br><span class="line">    // that it&#x27;s probably being debugged</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">antiFunction1 = dlsym(handle, &quot;antiFunction1&quot;);</span><br><span class="line">if ((error = dlerror()) != NULL)  &#123;</span><br><span class="line">    fputs(error, stderr);</span><br><span class="line"></span><br><span class="line">    // Same as above</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above snippet will properly gate in the a similar manner as before, but also prevent an issue where <code>dlerror()</code> could return a value to another function.</p>
<h2 id="TLDR"><a href="#TLDR" class="headerlink" title="TLDR"></a>TLDR</h2><p>Don’t let functions you know will fail, fail, when reversing. Seems obvious, though sometime when you’re reversing in smaller target it doesn’t matter. Hopefully this is mildly interesting to folks as it annoyed me for a day or so trying to figure out what was going on.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#The-setup"><span class="toc-number">1.</span> <span class="toc-text">The setup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#There-was-an-attempt%E2%80%A6"><span class="toc-number">2.</span> <span class="toc-text">There was an attempt…</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#The-bad-pattern"><span class="toc-number">3.</span> <span class="toc-text">The bad pattern</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fixing-the-issue"><span class="toc-number">4.</span> <span class="toc-text">Fixing the issue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLDR"><span class="toc-number">5.</span> <span class="toc-text">TLDR</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&text=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&is_video=false&description=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Tales from the crash; dlopen() and dlerror() patterns&body=Check out this article: https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&title=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&name=Tales from the crash; dlopen() and dlerror() patterns&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://strazzere.com/2020/05/Tales-from-the-crash-dlopen-and-dlerror/&t=Tales from the crash; dlopen() and dlerror() patterns"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2008-2024
    Tim Strazzere
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/strazzere">Projects</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
